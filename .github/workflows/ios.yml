name: iOS

on:
  workflow_dispatch:

jobs:
  ios-test:
    runs-on: macos-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ðŸ”¨ Build UIKitCatalog app
        run: |
          xcodebuild build \
            -project UIKitCatalog/UIKitCatalog.xcodeproj \
            -scheme UIKitCatalog \
            -sdk iphonesimulator \
            -derivedDataPath ./DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: ðŸ“¦ Install NPM packages
        run: npm ci

      - name: ðŸ“± List available simulators (debug)
        run: xcrun simctl list devices

      # Create and boot a clean simulator (iPhone 17 Pro, iOS 26.2)
      - name: ðŸ“± Create and boot simulator
        id: sim
        run: |
          DEVICE_NAME="iPhone 17 Pro"
          RUNTIME="com.apple.CoreSimulator.SimRuntime.iOS-26-2"
          DEVICE_TYPE="com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro"

          # Shutdown any running simulators
          xcrun simctl shutdown all || true

          # Delete existing simulator with same name (if any)
          xcrun simctl delete "$DEVICE_NAME" || true

          # Create new simulator and capture its UDID
          UDID=$(xcrun simctl create "$DEVICE_NAME" "$DEVICE_TYPE" "$RUNTIME")
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "Created simulator with UDID: $UDID"

          # Boot it
          xcrun simctl boot "$UDID"

          # Wait for boot to complete
          for i in {1..60}; do
            if xcrun simctl list devices | grep "$UDID" | grep -q "Booted"; then
              echo "Simulator booted"
              break
            fi
            echo "Waiting for boot... ($i/60)"
            sleep 2
          done
          # Extra time for UI to settle
          sleep 10

      - name: ðŸ§ª Run WebdriverIO Tests (CI config)
        env:
          APP_PATH: ${{ github.workspace }}/DerivedData/Build/Products/Debug-iphonesimulator/UIKitCatalog.app
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
        run: npx wdio run wdio.ci.conf.js

      - name: ðŸ“¤ Upload Mochawesome Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports/
