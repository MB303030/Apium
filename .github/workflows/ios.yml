name: iOS

on:
  workflow_dispatch:

jobs:
  ios-test:
    runs-on: macos-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ðŸ”¨ Build UIKitCatalog app
        run: |
          xcodebuild build \
            -project UIKitCatalog/UIKitCatalog.xcodeproj \
            -scheme UIKitCatalog \
            -sdk iphonesimulator \
            -derivedDataPath ./DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: ðŸ“¦ Install NPM packages
        run: npm ci

      - name: ðŸ“± Create fresh simulator and capture UDID
        id: create_sim
        run: |
          # Shutdown and delete any existing simulator with the same name
          xcrun simctl shutdown "iPhone 17 Pro" 2>/dev/null || true
          xcrun simctl delete "iPhone 17 Pro" 2>/dev/null || true

          # Create a new simulator and save its UDID
          UDID=$(xcrun simctl create "iPhone 17 Pro" "com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro" "com.apple.CoreSimulator.SimRuntime.iOS-26-2")
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "Created simulator with UDID: $UDID"

      - name: ðŸ“± Boot simulator and wait for full readiness
        run: |
          xcrun simctl boot ${{ env.SIMULATOR_UDID }}

          # Wait for boot to complete (using bootstatus)
          echo "Waiting for simulator to finish booting..."
          for i in {1..120}; do  # up to 4 minutes
            STATUS=$(xcrun simctl bootstatus ${{ env.SIMULATOR_UDID }} 2>&1 || true)
            if echo "$STATUS" | grep -q "already booted"; then
              echo "Simulator is booted."
              break
            fi
            if echo "$STATUS" | grep -q "booting"; then
              echo "Still booting... ($i/120)"
            fi
            sleep 2
          done

          # Additional wait for SpringBoard to be ready
          echo "Waiting 30 seconds for SpringBoard to settle..."
          sleep 30

          # Optional: Open the simulator window (not needed, but helpful for debugging)
          # open -a Simulator

          echo "Simulator ready."

      - name: ðŸ§ª Run WebdriverIO Tests
        env:
          APP_PATH: ${{ github.workspace }}/DerivedData/Build/Products/Debug-iphonesimulator/UIKitCatalog.app
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
        run: npx wdio run wdio.ci.conf.js

      - name: ðŸ“¤ Upload Mochawesome Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports/
