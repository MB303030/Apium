name: iOS111
on:
  workflow_dispatch:
    inputs:
      test_selection:
        description: 'Select the test(s) to run'
        required: true
        default: 'All Tests'
        type: choice
        options:
          - 'All Tests'
          - 'Date Picker Tests'
          - 'Login Tests'
          # Add more friendly names as needed

jobs:
  ios-test:
    runs-on: macos-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ðŸ”¨ Build UIKitCatalog app
        run: |
          xcodebuild build \
            -project UIKitCatalog/UIKitCatalog.xcodeproj \
            -scheme UIKitCatalog \
            -sdk iphonesimulator \
            -derivedDataPath ./DerivedData \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: ðŸ“¦ Install NPM packages
        run: npm ci

      - name: ðŸ“± Create fresh simulator and capture UDID
        id: create_sim
        run: |
          # Shutdown and delete any existing simulator with the same name
          xcrun simctl shutdown "iPhone 17 Pro" 2>/dev/null || true
          xcrun simctl delete "iPhone 17 Pro" 2>/dev/null || true

          # Create a new simulator and save its UDID
          UDID=$(xcrun simctl create "iPhone 17 Pro" "com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro" "com.apple.CoreSimulator.SimRuntime.iOS-26-2")
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV
          echo "Created simulator with UDID: $UDID"

      - name: ðŸ“± Boot simulator and wait for full readiness
        run: |
          xcrun simctl boot ${{ env.SIMULATOR_UDID }}

          # Wait for boot to complete (using bootstatus)
          echo "Waiting for simulator to finish booting..."
          for i in {1..120}; do  # up to 4 minutes
            STATUS=$(xcrun simctl bootstatus ${{ env.SIMULATOR_UDID }} 2>&1 || true)
            if echo "$STATUS" | grep -q "already booted"; then
              echo "Simulator is booted."
              break
            fi
            if echo "$STATUS" | grep -q "booting"; then
              echo "Still booting... ($i/120)"
            fi
            sleep 2
          done

          # Additional wait for SpringBoard to be ready
          echo "Waiting 30 seconds for SpringBoard to settle..."
          sleep 30

          echo "Simulator ready."

      - name: ðŸ”€ Map test selection to spec pattern
        id: map_spec
        run: |
          case "${{ github.event.inputs.test_selection }}" in
            "All Tests")
              echo "SPEC_PATTERN=./test/specs/**/*.js" >> $GITHUB_OUTPUT
              ;;
            "Date Picker Tests")
              echo "SPEC_PATTERN=./test/specs/datePicker.spec.js" >> $GITHUB_OUTPUT
              ;;
            "Login Tests")
              echo "SPEC_PATTERN=./test/specs/login.spec.js" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "SPEC_PATTERN=./test/specs/**/*.js" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: ðŸ§ª Run WebdriverIO Tests
        env:
          APP_PATH: ${{ github.workspace }}/DerivedData/Build/Products/Debug-iphonesimulator/UIKitCatalog.app
          SIMULATOR_UDID: ${{ env.SIMULATOR_UDID }}
        run: npx wdio run wdio.ci.conf.js --spec "${{ steps.map_spec.outputs.SPEC_PATTERN }}"

      - name: ðŸ“¤ Upload Mochawesome Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mochawesome-report
          path: reports/   # adjust if your reports folder is different
